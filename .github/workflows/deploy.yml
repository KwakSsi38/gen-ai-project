name: Node.js CI/CD

on:
  push:
    branches: [ "server" ]  # server ë¸Œëœì¹˜ì— push ì‹œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ğŸ“‚ ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js 20.x ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      - name: âš™ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: npm run build --if-present

      - name: âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test

      - name: ğŸ› ï¸ .env íŒŒì¼ ìƒì„±
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
          echo "GOOGLE_CREDENTIALS_B64=${{ secrets.GOOGLE_CREDENTIALS_B64 }}" >> .env

      - name: ğŸš€ ì„œë²„ ì‹¤í–‰ ë˜ëŠ” ì¬ì‹œì‘ (PM2)
        run: |
          if pm2 list | grep -q "caption-app"; then
            pm2 restart caption-app
          else
            pm2 start app.js --name caption-app
          fi
